# 开发工作流程参考文档

本文档专为 AI 助手设计，详细描述了在 Catalyst 项目中进行开发的工作流程和最佳实践，帮助 AI 更好地理解如何进行代码修改和功能开发。

## 1. 开发准备

### 1.1 环境检查
在开始开发前，确保以下环境已正确设置：
- Node.js v18+ 已安装
- pnpm 包管理器已安装
- 项目依赖已安装 (`pnpm install`)

### 1.2 分支管理
- 从 `develop` 分支创建功能分支: `git checkout -b feature/your-feature-name`
- 保持功能分支与 `develop` 分支同步: `git rebase develop`

## 2. 功能开发流程

### 2.1 需求分析
1. 明确功能需求和用户场景
2. 查看相关文档：
   - 需求文档: `docs/1_requirements/feature_requirements/`
   - 设计文档: `docs/2_design/`
   - API 文档: `docs/6_api/`
3. 确定影响范围和相关模块

### 2.2 技术设计
1. 确定实现方案
2. 识别需要修改或新增的文件
3. 设计 IPC 接口（如需要）
4. 设计组件结构（前端功能）

### 2.3 编码实现

#### 2.3.1 后端实现（主进程）
1. **服务层开发**:
   - 在 `src/main/services/` 中创建或修改服务类
   - 遵循现有服务模式，提供清晰的方法接口
   - 添加适当的错误处理

2. **IPC 处理**:
   - 在 `src/main/ipc-handlers/` 中创建或修改 IPC 处理器
   - 使用 `src/shared/ipc-events.ts` 中的事件常量
   - 遵循统一的响应格式: `{ success: boolean, data?: any, error?: string }`

3. **类型定义**:
   - 在需要的地方添加 TypeScript 类型定义
   - 更新 `src/renderer/types/electron.d.ts` 中的 API 类型定义

#### 2.3.2 前端实现（渲染进程）
1. **组件开发**:
   - 在 `src/renderer/components/` 中创建或修改组件
   - 遵循现有的组件设计模式
   - 使用 Styled Components 进行样式设计
   - 添加适当的动画效果（使用 Framer Motion）

2. **页面开发**:
   - 在 `src/renderer/pages/` 中创建或修改页面
   - 使用现有布局组件
   - 集成新功能组件

3. **状态管理**:
   - 使用 React Hooks 管理组件状态
   - 使用 React Context 进行全局状态管理（如需要）
   - 创建自定义 Hooks 封装复杂逻辑

4. **API 调用**:
   - 通过 `window.electronAPI` 访问主进程功能
   - 遵循现有 API 调用模式
   - 添加适当的加载和错误状态处理

### 2.4 预加载脚本更新
如果添加了新的 IPC 事件：
1. 更新 `src/shared/ipc-events.ts` 添加新的事件常量
2. 更新 `src/main/preload.ts` 暴露新的 API 方法
3. 更新 `src/renderer/types/electron.d.ts` 添加新的 API 类型定义

## 3. 代码质量保证

### 3.1 代码规范
1. 遵循项目现有的编码规范 (`docs/3_development/coding_standards.md`)
2. 使用 TypeScript 严格模式
3. 添加适当的注释和文档

### 3.2 代码检查
1. 运行 ESLint 检查: `pnpm lint`
2. 运行 Prettier 格式化: `pnpm format`
3. 确保没有错误和警告

### 3.3 类型检查
1. 运行 TypeScript 类型检查: `pnpm build`
2. 确保没有类型错误

## 4. 测试流程

### 4.1 手动测试
1. 启动开发服务器: `pnpm dev`
2. 测试新功能的所有场景
3. 测试相关功能是否受到影响
4. 在不同主题下测试 UI 显示

### 4.2 自动化测试（如适用）
1. 编写单元测试（如需要）
2. 运行测试套件: `pnpm test`

## 5. 文档更新

### 5.1 代码注释
1. 为新添加的函数和类添加 JSDoc 注释
2. 为复杂逻辑添加行内注释

### 5.2 技术文档
1. 更新相关的设计文档
2. 更新 API 文档（如添加了新的 IPC 接口）

### 5.3 用户文档
1. 更新用户手册（如添加了用户可见的功能）
2. 更新常见问题解答（如适用）

## 6. 提交和审查

### 6.1 代码提交
1. 添加修改的文件: `git add .`
2. 提交代码: `git commit -m "feat: description of changes"`
3. 遵循 conventional commits 格式

### 6.2 代码审查
1. 推送分支到远程仓库
2. 创建 Pull Request
3. 请求团队成员审查
4. 根据审查意见修改代码

## 7. 常见开发场景示例

### 7.1 添加新的配置项
1. 在 `Config` 接口和相关子接口中添加新的配置项类型定义
2. 在 `ConfigManager` 服务中添加处理新配置项的逻辑
3. 在 `config-ipc.ts` 中添加相关的 IPC 处理器
4. 在设置页面中添加对应的 UI 控件
5. 更新相关的文档

### 7.2 添加新的代理功能
1. 在 `MihomoService` 中添加新的功能方法
2. 在 `mihomo-ipc.ts` 中添加对应的 IPC 处理器
3. 在代理相关页面中添加对应的 UI 控件
4. 更新 `ProxyInfo` 接口（如需要）
5. 更新相关文档

### 7.3 添加新的 LLM 提供商
1. 在 `LLMService` 中添加新的提供商支持
2. 在 `llm-ipc.ts` 中添加对应的处理逻辑
3. 在聊天页面中添加对应的配置选项
4. 更新 `LLMConfig` 接口
5. 更新相关文档

## 8. 调试技巧

### 8.1 日志调试
1. 在主进程中使用 `console.log` 输出调试信息
2. 在渲染进程中使用浏览器开发者工具查看日志
3. 使用 `console.error` 输出错误信息

### 8.2 断点调试
1. 在 VS Code 中配置调试环境
2. 设置断点进行逐步调试
3. 使用 Electron 开发者工具调试渲染进程

### 8.3 网络调试
1. 使用浏览器开发者工具的网络面板查看 API 请求
2. 使用代理工具（如 Charles 或 Fiddler）监控网络流量

## 9. 性能优化考虑

### 9.1 渲染性能
1. 使用 React.memo 优化组件渲染
2. 使用 useMemo 和 useCallback 优化计算和函数创建
3. 避免在渲染函数中创建新对象

### 9.2 内存管理
1. 及时清理事件监听器
2. 避免内存泄漏
3. 合理使用缓存机制

### 9.3 网络优化
1. 合理使用缓存减少网络请求
2. 合并请求减少网络开销
3. 处理网络错误和超时

## 10. 错误处理最佳实践

### 10.1 异常捕获
1. 使用 try/catch 包装异步操作
2. 为 Promise 添加错误处理
3. 使用全局错误处理器捕获未处理的异常

### 10.2 用户反馈
1. 提供清晰的错误信息
2. 在适当的时候显示错误提示
3. 提供错误恢复选项

### 10.3 日志记录
1. 记录关键操作的日志
2. 记录错误信息用于调试
3. 避免在日志中记录敏感信息